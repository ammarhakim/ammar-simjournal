-- load app code
local App = dofile("../code/anisopoisson.lua")

local x0, y0 = 0.0, 0.0 -- location of O
local zet = 1e9 -- Dpar/Dperp
local Dpar = 1.0 -- parallel heat conduction
local Dperp = Dpar/zet -- perpendicular heat conduction

local bx = function(x, y)
   return -(y-y0)/math.sqrt((x-x0)^2+(y-y0)^2)
end
local by = function(x, y)
   return -(x-x0)/math.sqrt((x-x0)^2+(y-y0)^2)
end

aPoisson = App {
   polyOrder = 1,
   cflFrac = 0.9,
   lower = {-0.5, -0.5},
   upper = {0.5, 0.5},
   cells = {4, 4},

   bcLower = { {D=1, N=0, val=0.0}, {D=1, N=0, val=0.0} },
   bcUpper = { {D=1, N=0, val=0.0}, {D=1, N=0, val=0.0} },

   -- diffusion coefficients
   Dxx = function (t, z)
      local x, y = z[1], z[2]
      return Dpar*bx(x,y)^2 + Dperp*by(x,y)^2
   end,
   Dyy = function (t, z)
      local x, y = z[1], z[2]
      return Dperp*bx(x,y)^2 + Dpar*by(x,y)^2
   end,
   Dxy = function (t, z)
      local x, y = z[1], z[2]
      return (Dpar-Dperp)*bx(x,y)*by(x,y)
   end,

   -- source (RHS)
   src = function (t, z)
      local x, y = z[1], z[2]
      return (-(1.0*Dperp*y^3)/(32.0*y^4+64.0*x^2*y^2+32.0*x^4))-(1.0*Dperp*x*y^2)/(32.0*y^4+64.0*x^2*y^2+32.0*x^4)+(2.0*Dpar*x*y^2)/(32.0*y^4+64.0*x^2*y^2+32.0*x^4)+(Dperp*x^2*y)/(32.0*y^4+64.0*x^2*y^2+32.0*x^4)-(2.0*Dpar*x^2*y)/(32.0*y^4+64.0*x^2*y^2+32.0*x^4)+(Dperp*x^3)/(32.0*y^4+64.0*x^2*y^2+32.0*x^4)+(Dperp*y^4)/(16.0*y^4+32.0*x^2*y^2+16.0*x^4)-(2.0*Dperp*x^2*y^2)/(16.0*y^4+32.0*x^2*y^2+16.0*x^4)+(4.0*Dpar*x^2*y^2)/(16.0*y^4+32.0*x^2*y^2+16.0*x^4)+(Dperp*x^4)/(16.0*y^4+32.0*x^2*y^2+16.0*x^4)+(3.0*Dperp*y^5)/(8.0*y^4+16.0*x^2*y^2+8.0*x^4)+(Dperp*x*y^4)/(8.0*y^4+16.0*x^2*y^2+8.0*x^4)-(2.0*Dpar*x*y^4)/(8.0*y^4+16.0*x^2*y^2+8.0*x^4)-(2.0*Dperp*x^2*y^3)/(8.0*y^4+16.0*x^2*y^2+8.0*x^4)+(6.0*Dpar*x^2*y^3)/(8.0*y^4+16.0*x^2*y^2+8.0*x^4)+(2.0*Dpar*x*y^3)/(8.0*y^4+16.0*x^2*y^2+8.0*x^4)+(2.0*Dperp*x^3*y^2)/(8.0*y^4+16.0*x^2*y^2+8.0*x^4)-(6.0*Dpar*x^3*y^2)/(8.0*y^4+16.0*x^2*y^2+8.0*x^4)-(1.0*Dperp*x^4*y)/(8.0*y^4+16.0*x^2*y^2+8.0*x^4)+(2.0*Dpar*x^4*y)/(8.0*y^4+16.0*x^2*y^2+8.0*x^4)+(2.0*Dpar*x^3*y)/(8.0*y^4+16.0*x^2*y^2+8.0*x^4)-(3.0*Dperp*x^5)/(8.0*y^4+16.0*x^2*y^2+8.0*x^4)-(2.0*Dpar*x^2*y^4)/(4.0*y^4+8.0*x^2*y^2+4.0*x^4)-(1.0*Dperp*x*y^4)/(4.0*y^4+8.0*x^2*y^2+4.0*x^4)-(1.0*Dperp*x^2*y^3)/(4.0*y^4+8.0*x^2*y^2+4.0*x^4)+(2.0*Dpar*x^2*y^3)/(4.0*y^4+8.0*x^2*y^2+4.0*x^4)-(2.0*Dpar*x^4*y^2)/(4.0*y^4+8.0*x^2*y^2+4.0*x^4)+(Dperp*x^3*y^2)/(4.0*y^4+8.0*x^2*y^2+4.0*x^4)-(2.0*Dpar*x^3*y^2)/(4.0*y^4+8.0*x^2*y^2+4.0*x^4)+(Dperp*x^4*y)/(4.0*y^4+8.0*x^2*y^2+4.0*x^4)-(3.0*Dperp*x^2*y^5)/(2.0*y^4+4.0*x^2*y^2+2.0*x^4)-(2.0*Dperp*x*y^5)/(2.0*y^4+4.0*x^2*y^2+2.0*x^4)-(2.0*Dpar*x*y^5)/(2.0*y^4+4.0*x^2*y^2+2.0*x^4)-(3.0*Dperp*x^3*y^4)/(2.0*y^4+4.0*x^2*y^2+2.0*x^4)+(6.0*Dpar*x^3*y^4)/(2.0*y^4+4.0*x^2*y^2+2.0*x^4)+(3.0*Dperp*x^4*y^3)/(2.0*y^4+4.0*x^2*y^2+2.0*x^4)-(6.0*Dpar*x^4*y^3)/(2.0*y^4+4.0*x^2*y^2+2.0*x^4)+(4.0*Dperp*x^3*y^3)/(2.0*y^4+4.0*x^2*y^2+2.0*x^4)-(12.0*Dpar*x^3*y^3)/(2.0*y^4+4.0*x^2*y^2+2.0*x^4)+(3.0*Dperp*x^5*y^2)/(2.0*y^4+4.0*x^2*y^2+2.0*x^4)-(2.0*Dperp*x^5*y)/(2.0*y^4+4.0*x^2*y^2+2.0*x^4)-(2.0*Dpar*x^5*y)/(2.0*y^4+4.0*x^2*y^2+2.0*x^4)+(12.0*Dpar*x^3*y^5)/(y^4+2.0*x^2*y^2+x^4)+(Dperp*x^2*y^5)/(y^4+2.0*x^2*y^2+x^4)-(2.0*Dpar*x^2*y^5)/(y^4+2.0*x^2*y^2+x^4)+(Dperp*x^3*y^4)/(y^4+2.0*x^2*y^2+x^4)+(12.0*Dpar*x^5*y^3)/(y^4+2.0*x^2*y^2+x^4)-(1.0*Dperp*x^4*y^3)/(y^4+2.0*x^2*y^2+x^4)-(1.0*Dperp*x^5*y^2)/(y^4+2.0*x^2*y^2+x^4)+(2.0*Dpar*x^5*y^2)/(y^4+2.0*x^2*y^2+x^4)-(1.0*Dperp*y)/(64.0*y^2+64.0*x^2)+(Dpar*y)/(64.0*y^2+64.0*x^2)+(Dperp*x)/(64.0*y^2+64.0*x^2)-(1.0*Dpar*x)/(64.0*y^2+64.0*x^2)-(2.0*Dpar*y^2)/(32.0*y^2+32.0*x^2)+(Dperp*y)/(32.0*y^2+32.0*x^2)-(2.0*Dpar*x^2)/(32.0*y^2+32.0*x^2)-(1.0*Dperp*x)/(32.0*y^2+32.0*x^2)+(3.0*Dperp*y^3)/(16.0*y^2+16.0*x^2)-(3.0*Dpar*y^3)/(16.0*y^2+16.0*x^2)-(1.0*Dperp*x*y^2)/(16.0*y^2+16.0*x^2)+(Dpar*x*y^2)/(16.0*y^2+16.0*x^2)-(1.0*Dperp*y^2)/(16.0*y^2+16.0*x^2)+(Dperp*x^2*y)/(16.0*y^2+16.0*x^2)-(1.0*Dpar*x^2*y)/(16.0*y^2+16.0*x^2)+(2.0*Dperp*x*y)/(16.0*y^2+16.0*x^2)-(2.0*Dpar*x*y)/(16.0*y^2+16.0*x^2)-(3.0*Dperp*x^3)/(16.0*y^2+16.0*x^2)+(3.0*Dpar*x^3)/(16.0*y^2+16.0*x^2)-(1.0*Dperp*x^2)/(16.0*y^2+16.0*x^2)+(Dpar*y^4)/(8.0*y^2+8.0*x^2)-(6.0*Dperp*y^3)/(8.0*y^2+8.0*x^2)-(1.0*Dpar*y^3)/(8.0*y^2+8.0*x^2)+(2.0*Dpar*x^2*y^2)/(8.0*y^2+8.0*x^2)+(Dperp*x*y^2)/(8.0*y^2+8.0*x^2)+(4.0*Dpar*x*y^2)/(8.0*y^2+8.0*x^2)-(1.0*Dperp*x^2*y)/(8.0*y^2+8.0*x^2)-(4.0*Dpar*x^2*y)/(8.0*y^2+8.0*x^2)-(1.0*Dperp*x*y)/(8.0*y^2+8.0*x^2)-(1.0*Dpar*x*y)/(8.0*y^2+8.0*x^2)+(Dpar*x^4)/(8.0*y^2+8.0*x^2)+(6.0*Dperp*x^3)/(8.0*y^2+8.0*x^2)+(Dpar*x^3)/(8.0*y^2+8.0*x^2)-(3.0*Dperp*x^2*y^3)/(4.0*y^2+4.0*x^2)+(3.0*Dpar*x^2*y^3)/(4.0*y^2+4.0*x^2)-(4.0*Dperp*x*y^3)/(4.0*y^2+4.0*x^2)+(4.0*Dpar*x*y^3)/(4.0*y^2+4.0*x^2)+(3.0*Dperp*x^3*y^2)/(4.0*y^2+4.0*x^2)-(3.0*Dpar*x^3*y^2)/(4.0*y^2+4.0*x^2)+(2.0*Dperp*x^2*y^2)/(4.0*y^2+4.0*x^2)+(Dpar*x*y^2)/(4.0*y^2+4.0*x^2)-(4.0*Dperp*x^3*y)/(4.0*y^2+4.0*x^2)+(4.0*Dpar*x^3*y)/(4.0*y^2+4.0*x^2)-(1.0*Dpar*x^2*y)/(4.0*y^2+4.0*x^2)+(Dpar*y^5)/(2.0*y^2+2.0*x^2)-(3.0*Dpar*x*y^4)/(2.0*y^2+2.0*x^2)+(6.0*Dperp*x^2*y^3)/(2.0*y^2+2.0*x^2)+(Dpar*x^2*y^3)/(2.0*y^2+2.0*x^2)+(4.0*Dperp*x*y^3)/(2.0*y^2+2.0*x^2)+(6.0*Dpar*x*y^3)/(2.0*y^2+2.0*x^2)-(6.0*Dperp*x^3*y^2)/(2.0*y^2+2.0*x^2)-(1.0*Dpar*x^3*y^2)/(2.0*y^2+2.0*x^2)-(1.0*Dperp*x^2*y^2)/(2.0*y^2+2.0*x^2)+(Dpar*x^2*y^2)/(2.0*y^2+2.0*x^2)+(3.0*Dpar*x^4*y)/(2.0*y^2+2.0*x^2)+(4.0*Dperp*x^3*y)/(2.0*y^2+2.0*x^2)+(6.0*Dpar*x^3*y)/(2.0*y^2+2.0*x^2)-(1.0*Dpar*x^5)/(2.0*y^2+2.0*x^2)-(6.0*Dpar*x*y^5)/(y^2+x^2)-(24.0*Dpar*x^3*y^3)/(y^2+x^2)-(2.0*Dperp*x^2*y^3)/(y^2+x^2)+(3.0*Dpar*x^2*y^3)/(y^2+x^2)+(2.0*Dperp*x^3*y^2)/(y^2+x^2)-(3.0*Dpar*x^3*y^2)/(y^2+x^2)-(6.0*Dpar*x^5*y)/(y^2+x^2) 
   end,

   -- optional exact solution (App will compute projection)
   sol = function (t, z)
      local x, y = z[1], z[2]
      return (x-1/2)*(x+1/2)*(x-1/4)*(y-1/2)*(y+1/2)*(y+1/4)
   end  
}
aPoisson()
