-- load app code
local App = dofile("../code/anisopoisson.lua")

local x0, y0 = 1.0, 0.0 -- location of O-point
local zet = 1e9 -- Dpar/Dperp
local Dpar = 1.0 -- parallel heat conduction
local Dperp = Dpar/zet -- perpendicular heat conduction

local bx = function(x, y)
   return -(y-y0)/math.sqrt((x-x0)^2+(y-y0)^2)
end
local by = function(x, y)
   return (x-x0)/math.sqrt((x-x0)^2+(y-y0)^2)
end

aPoisson = App {
   polyOrder = 1,
   cflFrac = 0.9,
   lower = {-0.5, -0.5},
   upper = {0.5, 0.5},
   cells = {4, 4},

   bcLower = { {D=1, N=0, val=0.0}, {D=1, N=0, val=0.0} },
   bcUpper = { {D=1, N=0, val=0.0}, {D=1, N=0, val=0.0} },

   -- diffusion coefficients
   Dxx = function (t, z)
      local x, y = z[1], z[2]
      return Dpar*bx(x,y)^2 + Dperp*by(x,y)^2
   end,
   Dyy = function (t, z)
      local x, y = z[1], z[2]
      return Dperp*bx(x,y)^2 + Dpar*by(x,y)^2
   end,
   Dxy = function (t, z)
      local x, y = z[1], z[2]
      return (Dpar-Dperp)*bx(x,y)*by(x,y)
   end,

   -- source (RHS)
   src = function (t, z)
      local x, y = z[1], z[2]
      return (-(1.0*Dperp*y^3)/(32.0*y^4+64.0*x^2*y^2-128.0*x*y^2+64.0*y^2+32.0*x^4-128.0*x^3+192.0*x^2-128.0*x+32.0))+(Dperp*y^4)/(16.0*y^4+32.0*x^2*y^2-64.0*x*y^2+32.0*y^2+16.0*x^4-64.0*x^3+96.0*x^2-64.0*x+16.0)+(3.0*Dperp*y^5)/(8.0*y^4+16.0*x^2*y^2-32.0*x*y^2+16.0*y^2+8.0*x^4-32.0*x^3+48.0*x^2-32.0*x+8.0)+(Dperp*x^2*y^3)/(8.0*y^4+16.0*x^2*y^2-32.0*x*y^2+16.0*y^2+8.0*x^4-32.0*x^3+48.0*x^2-32.0*x+8.0)+(Dperp*x*y^3)/(8.0*y^4+16.0*x^2*y^2-32.0*x*y^2+16.0*y^2+8.0*x^4-32.0*x^3+48.0*x^2-32.0*x+8.0)-(3.0*Dperp*x^3*y^2)/(8.0*y^4+16.0*x^2*y^2-32.0*x*y^2+16.0*y^2+8.0*x^4-32.0*x^3+48.0*x^2-32.0*x+8.0)-(1.0*Dperp*x^2*y^4)/(4.0*y^4+8.0*x^2*y^2-16.0*x*y^2+8.0*y^2+4.0*x^4-16.0*x^3+24.0*x^2-16.0*x+4.0)-(1.0*Dperp*x*y^4)/(4.0*y^4+8.0*x^2*y^2-16.0*x*y^2+8.0*y^2+4.0*x^4-16.0*x^3+24.0*x^2-16.0*x+4.0)-(3.0*Dperp*x^2*y^5)/(2.0*y^4+4.0*x^2*y^2-8.0*x*y^2+4.0*y^2+2.0*x^4-8.0*x^3+12.0*x^2-8.0*x+2.0)-(3.0*Dperp*x*y^5)/(2.0*y^4+4.0*x^2*y^2-8.0*x*y^2+4.0*y^2+2.0*x^4-8.0*x^3+12.0*x^2-8.0*x+2.0)+(3.0*Dperp*x^3*y^4)/(2.0*y^4+4.0*x^2*y^2-8.0*x*y^2+4.0*y^2+2.0*x^4-8.0*x^3+12.0*x^2-8.0*x+2.0)-(4.0*Dperp*x^3*y^3)/(2.0*y^4+4.0*x^2*y^2-8.0*x*y^2+4.0*y^2+2.0*x^4-8.0*x^3+12.0*x^2-8.0*x+2.0)+(12.0*Dperp*x^3*y^5)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)-(7.0*Dperp*x^2*y^5)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(0.5*Dperp*x*y^5)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(0.5*Dperp*y^5)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(Dperp*x^3*y^4)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)-(1.75*Dperp*x^2*y^4)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(0.125*Dperp*x*y^4)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(0.125*Dperp*y^4)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(12.0*Dperp*x^5*y^3)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)-(32.5*Dperp*x^4*y^3)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(28.0*Dperp*x^3*y^3)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)-(3.875*Dperp*x^2*y^3)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)-(2.875*Dperp*x*y^3)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(0.75*Dperp*y^3)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(2.5*Dperp*x^5*y^2)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)-(7.0*Dperp*x^4*y^2)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(6.375*Dperp*x^3*y^2)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)-(1.125*Dperp*x^2*y^2)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)-(0.53125*Dperp*x*y^2)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(0.15625*Dperp*y^2)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)-(2.0*Dperp*x^5*y)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(5.875*Dperp*x^4*y)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)-(5.75*Dperp*x^3*y)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(1.71875*Dperp*x^2*y)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(0.3125*Dperp*x*y)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)-(0.15625*Dperp*y)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)-(0.375*Dperp*x^5)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(1.1875*Dperp*x^4)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)-(1.28125*Dperp*x^3)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(0.46875*Dperp*x^2)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(0.03125*Dperp*x)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)-(0.03125*Dperp)/(1.0*y^4+2.0*x^2*y^2-4.0*x*y^2+2.0*y^2+1.0*x^4-4.0*x^3+6.0*x^2-4.0*x+1.0)+(Dperp*y)/(64.0*y^2+64.0*x^2-128.0*x+64.0)-(1.0*Dpar*y)/(64.0*y^2+64.0*x^2-128.0*x+64.0)-(2.0*Dperp*y^2)/(32.0*y^2+32.0*x^2-64.0*x+32.0)+(Dperp*y)/(32.0*y^2+32.0*x^2-64.0*x+32.0)-(3.0*Dperp*y^3)/(16.0*y^2+16.0*x^2-32.0*x+16.0)+(3.0*Dpar*y^3)/(16.0*y^2+16.0*x^2-32.0*x+16.0)-(1.0*Dperp*y^2)/(16.0*y^2+16.0*x^2-32.0*x+16.0)-(1.0*Dperp*x^2*y)/(16.0*y^2+16.0*x^2-32.0*x+16.0)+(Dpar*x^2*y)/(16.0*y^2+16.0*x^2-32.0*x+16.0)-(1.0*Dperp*x*y)/(16.0*y^2+16.0*x^2-32.0*x+16.0)+(Dpar*x*y)/(16.0*y^2+16.0*x^2-32.0*x+16.0)+(3.0*Dperp*x^3)/(16.0*y^2+16.0*x^2-32.0*x+16.0)-(3.0*Dpar*x^3)/(16.0*y^2+16.0*x^2-32.0*x+16.0)+(Dpar*y^4)/(8.0*y^2+8.0*x^2-16.0*x+8.0)-(6.0*Dperp*y^3)/(8.0*y^2+8.0*x^2-16.0*x+8.0)-(1.0*Dpar*y^3)/(8.0*y^2+8.0*x^2-16.0*x+8.0)+(2.0*Dperp*x^2*y^2)/(8.0*y^2+8.0*x^2-16.0*x+8.0)-(1.0*Dpar*x^2*y^2)/(8.0*y^2+8.0*x^2-16.0*x+8.0)+(2.0*Dperp*x*y^2)/(8.0*y^2+8.0*x^2-16.0*x+8.0)+(2.0*Dpar*x*y^2)/(8.0*y^2+8.0*x^2-16.0*x+8.0)-(1.0*Dperp*x^2*y)/(8.0*y^2+8.0*x^2-16.0*x+8.0)-(1.0*Dperp*x*y)/(8.0*y^2+8.0*x^2-16.0*x+8.0)+(3.0*Dperp*x^3)/(8.0*y^2+8.0*x^2-16.0*x+8.0)+(3.0*Dperp*x^2*y^3)/(4.0*y^2+4.0*x^2-8.0*x+4.0)-(3.0*Dpar*x^2*y^3)/(4.0*y^2+4.0*x^2-8.0*x+4.0)+(3.0*Dperp*x*y^3)/(4.0*y^2+4.0*x^2-8.0*x+4.0)-(3.0*Dpar*x*y^3)/(4.0*y^2+4.0*x^2-8.0*x+4.0)-(3.0*Dperp*x^3*y^2)/(4.0*y^2+4.0*x^2-8.0*x+4.0)+(3.0*Dpar*x^3*y^2)/(4.0*y^2+4.0*x^2-8.0*x+4.0)+(Dperp*x^2*y^2)/(4.0*y^2+4.0*x^2-8.0*x+4.0)+(Dperp*x*y^2)/(4.0*y^2+4.0*x^2-8.0*x+4.0)+(4.0*Dperp*x^3*y)/(4.0*y^2+4.0*x^2-8.0*x+4.0)-(4.0*Dpar*x^3*y)/(4.0*y^2+4.0*x^2-8.0*x+4.0)+(Dpar*y^5)/(2.0*y^2+2.0*x^2-4.0*x+2.0)-(3.0*Dpar*x*y^4)/(2.0*y^2+2.0*x^2-4.0*x+2.0)+(6.0*Dperp*x^2*y^3)/(2.0*y^2+2.0*x^2-4.0*x+2.0)+(6.0*Dperp*x*y^3)/(2.0*y^2+2.0*x^2-4.0*x+2.0)+(3.0*Dpar*x*y^3)/(2.0*y^2+2.0*x^2-4.0*x+2.0)-(5.0*Dperp*x^3*y^2)/(2.0*y^2+2.0*x^2-4.0*x+2.0)+(Dpar*x^3*y^2)/(2.0*y^2+2.0*x^2-4.0*x+2.0)+(7.0*Dperp*x^3*y)/(2.0*y^2+2.0*x^2-4.0*x+2.0)-(3.0*Dpar*x^3*y)/(2.0*y^2+2.0*x^2-4.0*x+2.0)-(6.0*Dpar*x*y^5)/(y^2+1.0*x^2-2.0*x+1.0)-(48.0*Dperp*x^3*y^3)/(y^2+1.0*x^2-2.0*x+1.0)+(24.0*Dpar*x^3*y^3)/(y^2+1.0*x^2-2.0*x+1.0)+(44.0*Dperp*x^2*y^3)/(y^2+1.0*x^2-2.0*x+1.0)-(24.5*Dpar*x^2*y^3)/(y^2+1.0*x^2-2.0*x+1.0)-(9.25*Dperp*x*y^3)/(y^2+1.0*x^2-2.0*x+1.0)+(1.75*Dpar*x*y^3)/(y^2+1.0*x^2-2.0*x+1.0)-(1.75*Dperp*y^3)/(y^2+1.0*x^2-2.0*x+1.0)+(1.75*Dpar*y^3)/(y^2+1.0*x^2-2.0*x+1.0)-(5.5*Dperp*x^3*y^2)/(y^2+1.0*x^2-2.0*x+1.0)+(3.0*Dpar*x^3*y^2)/(y^2+1.0*x^2-2.0*x+1.0)+(9.25*Dperp*x^2*y^2)/(y^2+1.0*x^2-2.0*x+1.0)-(4.375*Dpar*x^2*y^2)/(y^2+1.0*x^2-2.0*x+1.0)-(2.1875*Dperp*x*y^2)/(y^2+1.0*x^2-2.0*x+1.0)+(0.3125*Dpar*x*y^2)/(y^2+1.0*x^2-2.0*x+1.0)-(0.3125*Dperp*y^2)/(y^2+1.0*x^2-2.0*x+1.0)+(0.3125*Dpar*y^2)/(y^2+1.0*x^2-2.0*x+1.0)-(6.0*Dpar*x^5*y)/(y^2+1.0*x^2-2.0*x+1.0)+(13.5*Dpar*x^4*y)/(y^2+1.0*x^2-2.0*x+1.0)+(1.5*Dperp*x^3*y)/(y^2+1.0*x^2-2.0*x+1.0)-(7.5*Dpar*x^3*y)/(y^2+1.0*x^2-2.0*x+1.0)-(7.5*Dperp*x^2*y)/(y^2+1.0*x^2-2.0*x+1.0)+(0.75*Dpar*x^2*y)/(y^2+1.0*x^2-2.0*x+1.0)+(2.0625*Dperp*x*y)/(y^2+1.0*x^2-2.0*x+1.0)+(2.0625*Dpar*x*y)/(y^2+1.0*x^2-2.0*x+1.0)+(0.1875*Dperp*y)/(y^2+1.0*x^2-2.0*x+1.0)-(0.5625*Dpar*y)/(y^2+1.0*x^2-2.0*x+1.0)-(0.5*Dpar*x^5)/(y^2+1.0*x^2-2.0*x+1.0)+(1.125*Dpar*x^4)/(y^2+1.0*x^2-2.0*x+1.0)+(0.375*Dperp*x^3)/(y^2+1.0*x^2-2.0*x+1.0)-(0.625*Dpar*x^3)/(y^2+1.0*x^2-2.0*x+1.0)-(1.4375*Dperp*x^2)/(y^2+1.0*x^2-2.0*x+1.0)+(0.0625*Dpar*x^2)/(y^2+1.0*x^2-2.0*x+1.0)+(0.484375*Dperp*x)/(y^2+1.0*x^2-2.0*x+1.0)+(0.171875*Dpar*x)/(y^2+1.0*x^2-2.0*x+1.0)+(0.015625*Dperp)/(y^2+1.0*x^2-2.0*x+1.0)-(0.046875*Dpar)/(y^2+1.0*x^2-2.0*x+1.0) 
   end,

   -- optional exact solution (App will compute projection)
   sol = function (t, z)
      local x, y = z[1], z[2]
      return (x-1/2)*(x+1/2)*(x-1/4)*(y-1/2)*(y+1/2)*(y+1/4)
   end  
}
aPoisson()
